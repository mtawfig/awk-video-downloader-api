const regexMatchAndReplace = (text, regex, replace) => {
  if(!text || !text.match) return;
  const candidates = text.match(regex);
  if(!candidates) return undefined;
  const formatted = candidates.map(candidate => {
    return candidate.replace(regex, replace);
  });
  return formatted;
}

const regexMatchAndReplaceOne = (text, regex, replace) => {
  const result = regexMatchAndReplace(text, regex, replace);
  return result && result[0] ? result[0] : null;
}

const extractPhone = (html) => {
  const regex =  /<div class="_50f4">Call (.*?)<\/div>/gi;
  const replace = '$1';
  return regexMatchAndReplaceOne(html, regex, replace);
};

const extractStreetAddress = (html) => {
  const regex = /"address":.*"streetAddress":"(.*?)(",|"})/gi;
  const replace = '$1';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractAddressLocality = (html) => {
  const regex = /"address":.*"addressLocality":"(.*?)(",|"})/gi;
  const replace = '$1';
  const result = regexMatchAndReplace(html, regex, replace);
  return result && result[0] ? result[0] : null;
}

const extractPostalCode = (html) => {
  const regex = /"address":.*"postalCode":"(.*?)(",|"})/gi;
  const replace = '$1';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractEmail = (html) => {
  const regex = /<a href="mailto:(.*?)(&#064;|@)(.*?)("|\?).*?>/gi;
  const replace = '$1@$3';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractWebsite = (html) => {
  const regex = /jhjEVDp3ViG\.png.*?<div class="_50f4">(http|https):\/\/(.*?)<\/div>/gi;
  const replace = '$1://$2';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractAggregateRating = (html) => {
  const regex = /AggregateRating","ratingValue":(.*?)(,"|})/gi;
  const replace = '$1';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractRatingCount = (html) => {
  const regex = /AggregateRating"(.*?)"ratingCount":(.*?)(,"|})/gi;
  const replace = '$2';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractAbout = (html) => {
  const regex = /<div class="_50f4">About<\/div><div class="_3-8w">(.*?)</gi;
  const replace = '$1';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extractBusinessCreationDate = (html) => {
  const regex = /Qz1rawS_hSy.png(.*?)<div class="_50f4">(Born in|Opened in|Founded on|Started in|Launched in|Created in) (.*?)<\/div>/gi;
  const replace = '$3';
  return regexMatchAndReplaceOne(html, regex, replace);
}

const extract = (html) => {
  const phone = extractPhone(html);
  const streetAddress = extractStreetAddress(html);
  const addressLocality = extractAddressLocality(html);
  const postalCode = extractPostalCode(html);
  const email = extractEmail(html);
  const website = extractWebsite(html);
  const ratingAggregate = extractAggregateRating(html);
  const ratingCount = extractRatingCount(html);
  const about = extractAbout(html);
  const creationDate = extractBusinessCreationDate(html);

  return {
    phone,
    streetAddress,
    addressLocality,
    postalCode,
    email,
    website,
    ratingAggregate,
    ratingCount,
    about,
    creationDate,
  };
}

module.exports = {
  extract,
  extractPhone,
  extractStreetAddress,
  extractAddressLocality,
  extractPostalCode,
  extractEmail,
  extractWebsite,
  extractAggregateRating,
  extractRatingCount,
  extractAbout,
  extractBusinessCreationDate,
}